# Release v1.3.0

## What's New

**100% Microsoft DevContainer Specification Compliance** - packnplay now fully implements every property in the Microsoft devcontainer.json specification. This milestone release completes our mission to provide full compatibility with the Microsoft devcontainer ecosystem.

## Features Added

### Docker Compose Orchestration
Full support for multi-container development environments using Docker Compose.

```json
{
  "dockerComposeFile": ["docker-compose.yml", "docker-compose.dev.yml"],
  "service": "app",
  "runServices": ["app", "db"]
}
```

- **dockerComposeFile**: Single or multiple compose files for layered configurations
- **service**: Primary service to connect to in the compose environment
- **runServices**: Selective service startup for faster iteration

### Complete Lifecycle Management

- **initializeCommand**: Execute commands on the host before container creation
- **Container Restart Behavior**: Automatic container restart with lifecycle command replay
- **shutdownAction**: Control container lifecycle on exit (none, stopContainer, stopCompose)
- **overrideCommand**: Control whether to override container CMD with user command
- **waitFor**: Specify which lifecycle command to complete before setup is finished

**Example:**
```json
{
  "initializeCommand": "npm install",
  "onCreateCommand": "cp .env.example .env",
  "postCreateCommand": "npm run db:migrate",
  "waitFor": "postCreateCommand",
  "shutdownAction": "stopContainer"
}
```

### User Management Properties

- **containerUser**: Separate user for container creation (docker run --user)
- **updateRemoteUserUID**: Sync container user UID/GID to match host (Linux only)
- **userEnvProbe**: Shell type for environment probing (none, loginShell, interactiveShell, loginInteractiveShell)

**Example:**
```json
{
  "remoteUser": "developer",
  "containerUser": "root",
  "updateRemoteUserUID": true,
  "userEnvProbe": "loginInteractiveShell"
}
```

### Port Configuration

- **portsAttributes**: Port-specific metadata including labels, protocols, and auto-forward behavior
- **requireLocalPort**: Fail if specific local port is unavailable
- **elevateIfNeeded**: Elevate permissions for privileged port binding (<1024)

**Example:**
```json
{
  "forwardPorts": [3000, 5432],
  "portsAttributes": {
    "3000": {
      "label": "Web App",
      "onAutoForward": "openBrowser",
      "requireLocalPort": true
    },
    "5432": {
      "label": "PostgreSQL",
      "onAutoForward": "silent"
    }
  }
}
```

### Host Requirements

Advisory validation for host system capabilities:

```json
{
  "hostRequirements": {
    "cpus": 4,
    "memory": "8gb",
    "storage": "32gb",
    "gpu": true
  }
}
```

### Feature Distribution

- **HTTPS Tarball Features**: Support for features distributed as HTTPS tarballs
- **Lockfile Support**: `devcontainer-lock.json` for reproducible builds with pinned feature versions

## Bug Fixes

- Fixed remoteEnv containerWorkspaceFolder variable substitution
- Fixed postAttachCommand format handling and container user execution
- Fixed capAdd and securityOpt empty string filtering
- Added warning when multiple features override entrypoint
- Fixed waitFor config field validation
- Fixed updateContentCommand lifecycle detection

## Security

- Fixed critical vulnerabilities in HTTPS tarball feature download with proper URL validation

## Breaking Changes

None! This release maintains full backward compatibility.

## Installation

### Homebrew (Recommended)
```bash
brew upgrade obra/tap/packnplay
```

### Build from Source
```bash
git clone https://github.com/obra/packnplay.git
cd packnplay
git checkout v1.3.0
make build
./packnplay version  # Should show v1.3.0
```

### Go Install
```bash
go install github.com/obra/packnplay@v1.3.0
```

## Usage Examples

### Complete DevContainer Configuration
```json
{
  "name": "Full-Stack Development",
  "dockerComposeFile": "docker-compose.yml",
  "service": "app",
  "remoteUser": "developer",
  "containerUser": "root",
  "updateRemoteUserUID": true,
  "userEnvProbe": "loginInteractiveShell",
  "features": {
    "ghcr.io/devcontainers/features/node:1": { "version": "20" },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {}
  },
  "forwardPorts": [3000, 5432],
  "portsAttributes": {
    "3000": { "label": "App", "onAutoForward": "openBrowser" }
  },
  "initializeCommand": "npm install",
  "postCreateCommand": "npm run db:setup",
  "waitFor": "postCreateCommand",
  "shutdownAction": "stopContainer",
  "hostRequirements": {
    "cpus": 4,
    "memory": "8gb"
  }
}
```

### Launch with Full Features
```bash
# Standard usage - all devcontainer features apply automatically
packnplay run

# With port mapping
packnplay run -p 8080:3000 npm start

# Attach to running container
packnplay attach
```

## Migration Guide

### From v1.2.0
No migration required! All existing configurations continue to work unchanged. New features are opt-in through devcontainer.json configuration.

### Recommended Updates
1. **Add lockfile**: Run with `devcontainer-lock.json` for reproducible builds
2. **Configure portsAttributes**: Add labels and auto-forward behavior for better DX
3. **Set hostRequirements**: Document system requirements for team members

## Technical Details

### Specification Compliance
packnplay now implements 100% of the Microsoft devcontainer.json specification:
- All image, Dockerfile, and Docker Compose configurations
- All lifecycle commands and timing controls
- All user management properties
- All port forwarding and attributes
- All environment variable handling with full substitution
- All mount configurations including workspaceMount
- All host requirements (advisory validation)

### Testing
- Comprehensive E2E test suite with real Docker integration
- Microsoft compliance tests for all specification properties
- Security testing for tarball downloads

## Thanks

This release represents months of work to achieve complete Microsoft devcontainer specification compliance. Thank you to everyone who reported issues, tested pre-release versions, and provided feedback.

---

**Full Changelog**: [v1.2.0...v1.3.0](https://github.com/obra/packnplay/compare/v1.2.0...v1.3.0)
