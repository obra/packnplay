# Release v1.2.0

## What's New

This major feature release introduces comprehensive OpenCode AI support and complete Microsoft DevContainer Features specification compliance, making packnplay the most advanced containerized AI coding environment available. With full OCI registry integration and enhanced development container support, v1.2.0 transforms how you work with AI coding assistants in isolated, reproducible environments.

## Features Added

### OpenCode AI Platform Integration
- **Complete Platform Support**: Full integration with the OpenCode AI coding platform
- **Automatic Configuration**: Seamless `.config/opencode/` directory mounting and `OPENCODE_API_KEY` environment variable handling
- **Enhanced AI Suite**: Expanded default container to include opencode-ai alongside existing tools (Claude Code, Codex, Gemini, etc.)

**Usage Example:**
```bash
# Launch OpenCode AI with automatic config mounting
packnplay run opencode

# Custom configuration path
packnplay run --env OPENCODE_CONFIG=/custom/path opencode
```

### Microsoft DevContainer Features Specification Compliance
- **OCI Registry Support**: Full `ghcr.io/devcontainers/features/*` support with oras CLI integration
- **Local Features**: Complete `.devcontainer/local-features/` directory support for custom features
- **Feature Options**: Advanced type validation, enum checking, and version constraint enforcement
- **Dependency Resolution**: Intelligent algorithm with circular dependency detection and resolution ordering
- **Lifecycle Hooks**: Complete support for postCreateCommand, updateContentCommand, postAttachCommand, and init/entrypoint
- **Feature Mounts**: Feature-contributed mount points with proper host path validation
- **Multi-stage Builds**: Automatic detection and OCI feature build context optimization

**Usage Example:**
```bash
# .devcontainer/devcontainer.json
{
  "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
  "features": {
    "ghcr.io/devcontainers/features/node:1": {
      "version": "20"
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "enableNonRootDocker": "true"
    }
  }
}
```

### Enhanced DevContainer Support
- **Variable Substitution**: Complete `${localEnv:VAR}` and `${containerEnv:VAR}` support in devcontainer.json
- **Custom Mounts**: Advanced mount processing with host path validation and security checks
- **Custom runArgs**: Full Docker argument integration with conflict detection
- **Port Forwarding**: Automatic port mapping from devcontainer `forwardPorts` configuration
- **Build Configuration**: Support for `cacheFrom` arrays and advanced build options
- **Lifecycle Commands**: Run-once behavior tracking for setup commands

## Bug Fixes

- **Symlink Resolution**: Fixed container reconnection issues on systems with symlinked paths (macOS `/var` → `/private/var`)
- **workspaceFolder Mapping**: Resolved shell execution issues with proper path handling
- **Port Validation**: Enhanced port range validation with comprehensive edge case testing
- **Container Cleanup**: Eliminated timeout warnings in E2E test suite
- **Build System**: Fixed E2E test port conflicts and build argument scoping

## Breaking Changes

None! This release maintains full backward compatibility while significantly expanding capabilities.

## Installation

### Homebrew (Recommended)
```bash
brew upgrade obra/tap/packnplay
```

### Build from Source
```bash
git clone https://github.com/obra/packnplay.git
cd packnplay
git checkout v1.2.0
make build
./packnplay version  # Should show v1.2.0
```

### Go Install
```bash
go install github.com/obra/packnplay@v1.2.0
```

## Usage Examples

### Microsoft Universal DevContainer Pattern
```bash
# Create .devcontainer/devcontainer.json
{
  "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
  "features": {
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": true
    },
    "ghcr.io/devcontainers/features/node:1": {
      "version": "20"
    }
  },
  "remoteUser": "vscode"
}

# Launch with automatic feature installation
packnplay run
```

### OpenCode AI with Custom Configuration
```bash
# Standard usage
packnplay run opencode

# With custom environment
packnplay run --env OPENCODE_API_KEY=your_key opencode

# With port forwarding
packnplay run -p 8080:3000 opencode
```

### Local Feature Development
```bash
# Create .devcontainer/local-features/my-feature/
mkdir -p .devcontainer/local-features/my-feature
echo '{"id": "my-feature", "name": "My Custom Feature"}' > .devcontainer/local-features/my-feature/devcontainer-feature.json
echo 'echo "Installing my feature"' > .devcontainer/local-features/my-feature/install.sh

# Use in devcontainer.json
{
  "image": "ubuntu:22.04",
  "features": {
    "./local-features/my-feature": {}
  }
}
```

## Technical Details

### Performance Improvements
- **Feature Caching**: Image ID-based caching with oras integration for fast subsequent builds
- **Multi-stage Optimization**: Automatic detection reduces build time and image size
- **Dependency Resolution**: Smart ordering minimizes feature installation conflicts

### Testing Enhancements
- **E2E Coverage**: Comprehensive test suite covering real OCI registry integration
- **Specification Compliance**: Microsoft DevContainer Features specification verification
- **Edge Case Testing**: Advanced scenarios including multi-stage builds and complex dependencies

### Architecture
- **Feature Resolution Priority**: OCI registry → local features → fallback installation
- **Build System**: Multi-stage Docker builds with automatic feature detection
- **Variable Substitution**: Complete environment variable expansion with security validation

## Migration Guide

### From v1.1.0
No migration required! All existing configurations continue to work unchanged. New features are opt-in through devcontainer.json configuration.

### Recommended Updates
1. **Add devcontainer.json**: Leverage new Microsoft features for more reliable, maintainable environments
2. **Use OCI Features**: Replace manual tool installation with official Microsoft features
3. **Enable OpenCode AI**: Add to your AI coding workflow alongside existing tools

## Thanks

Special recognition for community feedback and contributions that made this comprehensive feature set possible. This release represents months of development focused on Microsoft DevContainer Features specification compliance and expanded AI platform support.

---

**Full Changelog**: [v1.1.0...v1.2.0](https://github.com/obra/packnplay/compare/v1.1.0...v1.2.0)
**Issues Fixed**: See [GitHub Issues](https://github.com/obra/packnplay/issues?q=milestone%3Av1.2.0)